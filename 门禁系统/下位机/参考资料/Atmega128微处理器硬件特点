ATmega128微处理器的硬件特点

ATmega128的MCU包括一个算术逻辑单元(ALU) ，一个状态寄存器(SREG) ，一个通用工作寄存器组和一个堆栈指针。状态寄存器(SREG) 的最高位I是全局中断允许位。如果全局中断允许位为零，则所有中断都被禁止。当系统响应一个中断后，I位将由硬件自动清“0”；当执行中断返回 (RETI) 指令时，I位由硬件自动置“1”，从而允许系统再次响应下一个中断请求。通用工作寄存器组是由32个8位的通用工作寄存器组成。其中R26～R31这6 个寄存器还可以两两合并为3 个16位的间接地址寄存器，这些寄存器可以用来对数据存储空间和程序存储空间进行间接寻址的寄存器。堆栈指针(SP) 是一个指示堆栈顶部地址的16 位寄存器。ATmega128单片机的硬件堆栈的生长方向是向下的(从高地址向低地址生长) ，所以软件堆栈在定义的时候，也要采取相同的生长方向。ATmega128单片机的数据存储器是线形的，从低地址到高地址依次是CPU寄存器区(32个通用寄存器) ，I/O寄存器区，数据存储区。

ATmega128的中断响应机制

ATmega128有34个不同的中断源，每个中断源和系统复位在程序存储空间都有一个独立的中断向量(中断入口地址) 。每个中断源都有各自独立的中断允许控制位，当某个中断源的中断允许控制位为“1”且全局中断允许位I也为“1”时，系统才响应该中断。当系统响应一个中断请求后，会自动将全局中断允许位I清零，此时，后续中断响应被屏蔽。当系统执行中断返回指令RETI时，会将全局中断允许位I置“1”，以允许响应下一个中断。若用户想实现中断嵌套，必须在中断服务子程序中将全局中断允许位I置“1”。在中断向量表中，处于低地址的中断具有高的优先级。优先级高只是表明在多个中断同时发生的时候，系统先响应优先级高的中断，并不含有高优先级的中断能打断低优先级的中断处理工作的意思。由于μC/OS-Ⅱ的任务切换实际上是模拟一次中断，因此需要知道CPU的中断响应机制。中断发生时，ATmega128按以下步骤顺序执行：
(1) 全局中断允许位I清零。
(2) 将指向下一条指令的PC值压入堆栈，同时堆栈指针SP减2。
(3) 选择最高优先级的中断向量装入PC，程序从此地址继续执行中断处理。
(4) 当执行中断处理时，中断源的中断允许控制位清零。中断结束后，执行RETI指令，此时：
①全局中断允许位I置“1”。
② PC从堆栈推出，程序从被中断的地方继续执行。特别要注意的是：ATmega128A单片机在响应中断及从中断返回时，并不会对状态寄存器SREG 和通用寄存器自动进行保存和恢复操作，因此，对状态寄存器SREG 和通用寄存器的中断保护工作必须由用户来完成。

ATmega128的定时器中断

ATmega128有三个定时器：T0，T1，T2，可以为μCOS-II提供精确的时钟源。 ATmega128的三个定时器都有计数溢出中断功能，而且T1和T2还有匹配比较中断，即定时器计数到设定的值时，产生中断并自动清零。若系统采用这种中断方式，其好处是在中断服务程序ISR中不需要重新装载定时器的值。

